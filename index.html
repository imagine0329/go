<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go - ì˜ì–´ ê³µë¶€ ì•±</title>
    <style>
        /* ===== ë¦¬ì…‹ & ê¸°ë³¸ ===== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
        }

        /* ===== í—¤ë” ===== */
        header {
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: #fff;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .logo { font-size: 24px; font-weight: 800; letter-spacing: 2px; }
        .user-info { display: flex; align-items: center; gap: 12px; }
        .user-info span { font-size: 14px; }
        .btn-logout {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.4);
            color: #fff;
            padding: 6px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 13px;
            transition: background 0.2s;
        }
        .btn-logout:hover { background: rgba(255,255,255,0.35); }

        /* ===== íƒ­ ë„¤ë¹„ê²Œì´ì…˜ ===== */
        .tab-nav {
            display: flex;
            background: #fff;
            border-bottom: 1px solid #ddd;
            padding: 0 24px;
        }
        .tab-nav button {
            background: none;
            border: none;
            padding: 14px 24px;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }
        .tab-nav button.active { color: #1a73e8; border-bottom-color: #1a73e8; }
        .tab-nav button:hover { color: #1a73e8; }

        /* ===== ë©”ì¸ ì»¨í…Œì´ë„ˆ ===== */
        .container { max-width: 960px; margin: 0 auto; padding: 24px; }

        /* ===== ë¡œê·¸ì¸ / íšŒì›ê°€ì… ===== */
        .auth-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: calc(100vh - 60px);
        }
        .auth-box {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.1);
            padding: 48px 40px;
            width: 400px;
            text-align: center;
        }
        .auth-box h2 { margin-bottom: 8px; color: #1a73e8; font-size: 28px; }
        .auth-box .subtitle { color: #888; font-size: 14px; margin-bottom: 32px; }
        .auth-box input {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 14px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            transition: border 0.2s;
        }
        .auth-box input:focus { border-color: #1a73e8; }
        .btn-primary {
            width: 100%;
            padding: 13px;
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-top: 6px;
        }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        .auth-toggle { margin-top: 20px; font-size: 13px; color: #888; }
        .auth-toggle a { color: #1a73e8; cursor: pointer; text-decoration: underline; }
        .auth-error { color: #e74c3c; font-size: 13px; margin-bottom: 10px; min-height: 20px; }

        /* ===== ê³µìœ  í”¼ë“œ ===== */
        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .feed-header h2 { font-size: 22px; }
        .btn-new-post {
            background: #1a73e8;
            color: #fff;
            border: none;
            padding: 10px 22px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        .btn-new-post:hover { background: #1558b0; }

        .post-form {
            background: #fff;
            border-radius: 14px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            margin-bottom: 24px;
            display: none;
        }
        .post-form.show { display: block; }
        .post-form select,
        .post-form input,
        .post-form textarea {
            width: 100%;
            padding: 11px 14px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            font-family: inherit;
        }
        .post-form textarea { height: 120px; resize: vertical; }
        .post-form .form-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .post-form .form-actions button {
            padding: 10px 24px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        .btn-submit { background: #1a73e8; color: #fff; }
        .btn-cancel { background: #eee; color: #555; }

        .post-card {
            background: #fff;
            border-radius: 14px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            margin-bottom: 16px;
            transition: transform 0.15s;
        }
        .post-card:hover { transform: translateY(-2px); }
        .post-card .post-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .post-card .post-author { font-weight: 700; color: #1a73e8; font-size: 15px; }
        .post-card .post-date { font-size: 12px; color: #aaa; }
        .post-card .post-category {
            display: inline-block;
            background: #e8f0fe;
            color: #1a73e8;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
        }
        .post-card .post-title { font-size: 17px; font-weight: 700; margin-bottom: 8px; }
        .post-card .post-body { font-size: 14px; color: #555; line-height: 1.7; white-space: pre-wrap; }
        .post-card .post-actions { margin-top: 14px; display: flex; gap: 12px; }
        .post-card .post-actions button {
            background: none;
            border: 1px solid #ddd;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
        }
        .post-card .post-actions button:hover {
            background: #f5f5f5;
            color: #1a73e8;
            border-color: #1a73e8;
        }
        .post-card .post-actions button.liked {
            background: #e8f0fe;
            color: #1a73e8;
            border-color: #1a73e8;
        }

        /* ëŒ“ê¸€ */
        .comments-section {
            margin-top: 14px;
            border-top: 1px solid #eee;
            padding-top: 14px;
            display: none;
        }
        .comments-section.show { display: block; }
        .comment-item {
            background: #f8f9fa;
            padding: 10px 14px;
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .comment-item strong { color: #1a73e8; }
        .comment-input-row { display: flex; gap: 8px; margin-top: 8px; }
        .comment-input-row input {
            flex: 1;
            padding: 9px 14px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 13px;
            outline: none;
        }
        .comment-input-row button {
            padding: 9px 18px;
            background: #1a73e8;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            cursor: pointer;
        }

        /* ===== ë©¤ë²„ ê´€ë¦¬ ===== */
        .member-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }
        .stat-card {
            background: #fff;
            border-radius: 14px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
        .stat-card .stat-number { font-size: 32px; font-weight: 800; color: #1a73e8; }
        .stat-card .stat-label { font-size: 13px; color: #888; margin-top: 4px; }
        .member-list { list-style: none; }
        .member-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .member-item .member-info { display: flex; align-items: center; gap: 14px; }
        .member-avatar {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: linear-gradient(135deg, #1a73e8, #0d47a1);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
        }
        .member-name { font-weight: 600; font-size: 15px; }
        .member-role { font-size: 12px; color: #888; }
        .member-item .member-actions button {
            background: none;
            border: 1px solid #ddd;
            padding: 6px 14px;
            border-radius: 8px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 6px;
            transition: all 0.2s;
        }
        .member-item .member-actions button:hover { border-color: #e74c3c; color: #e74c3c; }

        /* ===== ë‚´ í•™ìŠµ ===== */
        .my-study-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .vocab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        .vocab-card {
            background: #fff;
            border-radius: 14px;
            padding: 22px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            cursor: pointer;
            transition: transform 0.15s;
            position: relative;
        }
        .vocab-card:hover { transform: translateY(-2px); }
        .vocab-card .word { font-size: 20px; font-weight: 700; color: #1a73e8; margin-bottom: 6px; }
        .vocab-card .meaning { font-size: 14px; color: #555; margin-bottom: 8px; }
        .vocab-card .example { font-size: 13px; color: #888; font-style: italic; line-height: 1.5; }
        .vocab-card .vocab-status {
            position: absolute;
            top: 14px;
            right: 14px;
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 20px;
            font-weight: 600;
        }
        .status-learning { background: #fff3e0; color: #e65100; }
        .status-done { background: #e8f5e9; color: #2e7d32; }

        /* ëª¨ë‹¬ */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 200;
        }
        .modal-overlay.show { display: flex; }
        .modal {
            background: #fff;
            border-radius: 16px;
            padding: 36px;
            width: 440px;
            max-width: 90vw;
            box-shadow: 0 8px 40px rgba(0,0,0,0.15);
        }
        .modal h3 { margin-bottom: 20px; font-size: 20px; color: #1a73e8; }
        .modal input,
        .modal textarea {
            width: 100%;
            padding: 11px 14px;
            margin-bottom: 12px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 14px;
            outline: none;
            font-family: inherit;
        }
        .modal textarea { height: 80px; resize: vertical; }
        .modal .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 6px; }
        .modal .form-actions button {
            padding: 10px 24px;
            border-radius: 10px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .page { display: none; }
        .page.active { display: block; }

        .empty-state { text-align: center; padding: 60px 20px; color: #aaa; }
        .empty-state .emoji { font-size: 48px; margin-bottom: 16px; }
        .empty-state p { font-size: 15px; }

        .search-bar {
            width: 100%;
            padding: 12px 18px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 14px;
            outline: none;
            margin-bottom: 20px;
            background: #fff;
        }
        .search-bar:focus { border-color: #1a73e8; }

        /* ë¡œë”© */
        .loading { text-align: center; padding: 60px; color: #888; font-size: 16px; }
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid #e0e0e0;
            border-top-color: #1a73e8;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: #333;
            color: #fff;
            padding: 12px 28px;
            border-radius: 10px;
            font-size: 14px;
            z-index: 300;
            transition: transform 0.3s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        @media (max-width: 600px) {
            .auth-box { padding: 32px 24px; width: 90vw; }
            .tab-nav button { padding: 12px 14px; font-size: 13px; }
            .container { padding: 16px; }
        }
    </style>
</head>
<body>

    <!-- ===== ë¡œê·¸ì¸ / íšŒì›ê°€ì… ===== -->
    <div id="authPage">
        <header>
            <div class="logo">GO</div>
        </header>
        <div class="auth-wrapper">
            <div class="auth-box" id="loginBox">
                <h2>ğŸ‘‹ Welcome Back</h2>
                <p class="subtitle">ì˜ì–´ ê³µë¶€ë¥¼ í•¨ê»˜ ì‹œì‘í•´ìš”</p>
                <div class="auth-error" id="loginError"></div>
                <input type="email" id="loginEmail" placeholder="ì´ë©”ì¼">
                <input type="password" id="loginPw" placeholder="ë¹„ë°€ë²ˆí˜¸" onkeydown="if(event.key==='Enter')handleLogin()">
                <button class="btn-primary" id="loginBtn" onclick="handleLogin()">ë¡œê·¸ì¸</button>
                <div class="auth-toggle">
                    ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a onclick="showRegister()">íšŒì›ê°€ì…</a>
                </div>
            </div>
            <div class="auth-box" id="registerBox" style="display:none;">
                <h2>ğŸ“ íšŒì›ê°€ì…</h2>
                <p class="subtitle">ìƒˆ ê³„ì •ì„ ë§Œë“¤ì–´ ë³´ì„¸ìš”</p>
                <div class="auth-error" id="registerError"></div>
                <input type="text" id="regName" placeholder="ì´ë¦„ (ë‹‰ë„¤ì„)">
                <input type="email" id="regEmail" placeholder="ì´ë©”ì¼">
                <input type="password" id="regPw" placeholder="ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
                <input type="password" id="regPwConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" onkeydown="if(event.key==='Enter')handleRegister()">
                <button class="btn-primary" id="regBtn" onclick="handleRegister()">ê°€ì…í•˜ê¸°</button>
                <div class="auth-toggle">
                    ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a onclick="showLogin()">ë¡œê·¸ì¸</a>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== ë©”ì¸ ì•± ===== -->
    <div id="mainApp" style="display:none;">
        <header>
            <div class="logo">GO</div>
            <div class="user-info">
                <span id="currentUserName"></span>
                <button class="btn-logout" onclick="handleLogout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </header>
        <div class="tab-nav">
            <button class="active" onclick="switchTab('feed', this)">ğŸ“¢ í•™ìŠµ ê³µìœ </button>
            <button onclick="switchTab('study', this)">ğŸ“– ë‚´ í•™ìŠµ</button>
            <button onclick="switchTab('members', this)">ğŸ‘¥ ë©¤ë²„ ê´€ë¦¬</button>
        </div>
        <div class="container">
            <!-- íƒ­: í•™ìŠµ ê³µìœ  í”¼ë“œ -->
            <div id="feedPage" class="page active">
                <div class="feed-header">
                    <h2>ğŸ“¢ í•™ìŠµ ê³µìœ  í”¼ë“œ</h2>
                    <button class="btn-new-post" onclick="togglePostForm()">âœï¸ ìƒˆ ê¸€ ì‘ì„±</button>
                </div>
                <div class="post-form" id="postForm">
                    <select id="postCategory">
                        <option value="ë‹¨ì–´">ğŸ“— ë‹¨ì–´</option>
                        <option value="ë¬¸ë²•">ğŸ“˜ ë¬¸ë²•</option>
                        <option value="íšŒí™”">ğŸ“™ íšŒí™”</option>
                        <option value="íŒ">ğŸ’¡ íŒ</option>
                        <option value="ì§ˆë¬¸">â“ ì§ˆë¬¸</option>
                    </select>
                    <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                    <textarea id="postContent" placeholder="í•™ìŠµ ë‚´ìš©ì„ ê³µìœ í•´ ì£¼ì„¸ìš”..."></textarea>
                    <div class="form-actions">
                        <button class="btn-cancel" onclick="togglePostForm()">ì·¨ì†Œ</button>
                        <button class="btn-submit" onclick="submitPost()">ê²Œì‹œí•˜ê¸°</button>
                    </div>
                </div>
                <input type="text" class="search-bar" id="feedSearch" placeholder="ğŸ” ì œëª©, ë‚´ìš©, ì‘ì„±ì ê²€ìƒ‰..." oninput="renderFeed()">
                <div id="feedList"><div class="loading"><div class="spinner"></div>ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>
            </div>

            <!-- íƒ­: ë‚´ í•™ìŠµ (ë‹¨ì–´ì¥) -->
            <div id="studyPage" class="page">
                <div class="my-study-header">
                    <h2>ğŸ“– ë‚´ ë‹¨ì–´ì¥</h2>
                    <button class="btn-new-post" onclick="openVocabModal()">â• ë‹¨ì–´ ì¶”ê°€</button>
                </div>
                <input type="text" class="search-bar" id="vocabSearch" placeholder="ğŸ” ë‹¨ì–´ ê²€ìƒ‰..." oninput="renderVocab()">
                <div class="vocab-grid" id="vocabGrid"></div>
            </div>

            <!-- íƒ­: ë©¤ë²„ ê´€ë¦¬ -->
            <div id="membersPage" class="page">
                <h2 style="margin-bottom:20px;">ğŸ‘¥ ë©¤ë²„ ê´€ë¦¬</h2>
                <div class="member-stats" id="memberStats"></div>
                <input type="text" class="search-bar" id="memberSearch" placeholder="ğŸ” ë©¤ë²„ ê²€ìƒ‰..." oninput="renderMembers()">
                <ul class="member-list" id="memberList"></ul>
            </div>
        </div>
    </div>

    <!-- ë‹¨ì–´ ì¶”ê°€ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="vocabModal">
        <div class="modal">
            <h3>â• ìƒˆ ë‹¨ì–´ ì¶”ê°€</h3>
            <input type="text" id="vocabWord" placeholder="ì˜ì–´ ë‹¨ì–´">
            <input type="text" id="vocabMeaning" placeholder="ëœ» (í•œêµ­ì–´)">
            <textarea id="vocabExample" placeholder="ì˜ˆë¬¸ (ì„ íƒ)"></textarea>
            <div class="form-actions">
                <button class="btn-cancel" onclick="closeVocabModal()">ì·¨ì†Œ</button>
                <button class="btn-submit" onclick="addVocab()">ì¶”ê°€</button>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div class="toast" id="toast"></div>

    <!-- ===== Firebase SDK (compat ë²„ì „) ===== -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script>
    // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyAjtK1_9ZonzhCSmZRtMq1ivx0JoPEZZlc",
    authDomain: "imagine-ba6c2.firebaseapp.com",
    projectId: "imagine-ba6c2",
    storageBucket: "imagine-ba6c2.firebasestorage.app",
    messagingSenderId: "859919770205",
    appId: "1:859919770205:web:56c5fbdff4c8411df663b4",
    measurementId: "G-VENT6D51EV"
  };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.firestore();

    // ===== ì•± ìƒíƒœ =====
    let currentUser = null;   // { uid, email, name, role, joinDate }
    let allPosts    = [];
    let myVocabs    = [];
    let allMembers  = [];

    // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ í•´ì œìš©
    let unsubPosts   = null;
    let unsubVocabs  = null;
    let unsubMembers = null;

    // ===== í† ìŠ¤íŠ¸ =====
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2500);
    }

    // ===== ì¸ì¦ ìƒíƒœ ê°ì‹œ (ìë™ ë¡œê·¸ì¸ í¬í•¨) =====
    auth.onAuthStateChanged(async (user) => {
        if (user) {
            const doc = await db.collection('users').doc(user.uid).get();
            if (doc.exists) {
                currentUser = { uid: user.uid, ...doc.data() };
            } else {
                currentUser = {
                    uid: user.uid,
                    email: user.email,
                    name: user.email.split('@')[0],
                    role: 'member',
                    joinDate: new Date().toISOString().slice(0, 10)
                };
            }
            showMainApp();
        } else {
            currentUser = null;
            detachListeners();
            showAuth();
        }
    });

    // ===== UI ì „í™˜ =====
    function showAuth() {
        document.getElementById('authPage').style.display = '';
        document.getElementById('mainApp').style.display = 'none';
    }
    function showMainApp() {
        document.getElementById('authPage').style.display = 'none';
        document.getElementById('mainApp').style.display = '';
        document.getElementById('currentUserName').textContent = 'ğŸ‘¤ ' + currentUser.name;
        attachListeners();
    }
    function showLogin() {
        document.getElementById('loginBox').style.display = '';
        document.getElementById('registerBox').style.display = 'none';
        document.getElementById('loginError').textContent = '';
    }
    function showRegister() {
        document.getElementById('loginBox').style.display = 'none';
        document.getElementById('registerBox').style.display = '';
        document.getElementById('registerError').textContent = '';
    }

    // ===== íšŒì›ê°€ì… =====
    async function handleRegister() {
        const name  = document.getElementById('regName').value.trim();
        const email = document.getElementById('regEmail').value.trim();
        const pw    = document.getElementById('regPw').value;
        const pwc   = document.getElementById('regPwConfirm').value;
        const errEl = document.getElementById('registerError');
        errEl.textContent = '';

        if (!name || !email || !pw) { errEl.textContent = 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; return; }
        if (pw.length < 6)          { errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.'; return; }
        if (pw !== pwc)             { errEl.textContent = 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.'; return; }

        const btn = document.getElementById('regBtn');
        btn.disabled = true;
        btn.textContent = 'ê°€ì… ì¤‘...';

        try {
            const cred = await auth.createUserWithEmailAndPassword(email, pw);
            const today = new Date().toISOString().slice(0, 10);
            await db.collection('users').doc(cred.user.uid).set({
                email, name, role: 'member', joinDate: today
            });
            showToast('ğŸ‰ íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
        } catch (e) {
            errEl.textContent = firebaseErrorMsg(e.code);
        } finally {
            btn.disabled = false;
            btn.textContent = 'ê°€ì…í•˜ê¸°';
        }
    }

    // ===== ë¡œê·¸ì¸ =====
    async function handleLogin() {
        const email = document.getElementById('loginEmail').value.trim();
        const pw    = document.getElementById('loginPw').value;
        const errEl = document.getElementById('loginError');
        errEl.textContent = '';

        if (!email || !pw) { errEl.textContent = 'ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”.'; return; }

        const btn = document.getElementById('loginBtn');
        btn.disabled = true;
        btn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

        try {
            await auth.signInWithEmailAndPassword(email, pw);
        } catch (e) {
            errEl.textContent = firebaseErrorMsg(e.code);
        } finally {
            btn.disabled = false;
            btn.textContent = 'ë¡œê·¸ì¸';
        }
    }

    // ===== ë¡œê·¸ì•„ì›ƒ =====
    function handleLogout() { auth.signOut(); }

    // ===== ì—ëŸ¬ í•œê¸€í™” =====
    function firebaseErrorMsg(code) {
        const m = {
            'auth/email-already-in-use': 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.',
            'auth/invalid-email':        'ì˜¬ë°”ë¥¸ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.',
            'auth/weak-password':        'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. (6ì ì´ìƒ)',
            'auth/user-not-found':       'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.',
            'auth/wrong-password':       'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
            'auth/invalid-credential':   'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
            'auth/too-many-requests':    'ë„ˆë¬´ ë§ì€ ì‹œë„ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.',
        };
        return m[code] || 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.';
    }

    // ===== ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ =====
    function attachListeners() {
        // ê²Œì‹œê¸€
        unsubPosts = db.collection('posts')
            .orderBy('createdAt', 'desc')
            .onSnapshot(snap => {
                allPosts = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderFeed();
            });

        // ë‚´ ë‹¨ì–´ì¥
        unsubVocabs = db.collection('vocabs')
            .where('uid', '==', currentUser.uid)
            .orderBy('createdAt', 'desc')
            .onSnapshot(snap => {
                myVocabs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                renderVocab();
            });

        // ë©¤ë²„ ëª©ë¡
        unsubMembers = db.collection('users')
            .onSnapshot(snap => {
                allMembers = snap.docs.map(d => ({ uid: d.id, ...d.data() }));
                renderMembers();
            });
    }

    function detachListeners() {
        if (unsubPosts)   unsubPosts();
        if (unsubVocabs)  unsubVocabs();
        if (unsubMembers) unsubMembers();
    }

    // ===== íƒ­ ì „í™˜ =====
    function switchTab(tab, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-nav button').forEach(b => b.classList.remove('active'));
        document.getElementById(tab + 'Page').classList.add('active');
        btn.classList.add('active');
    }

    // ===== í•™ìŠµ ê³µìœ  í”¼ë“œ =====
    function togglePostForm() {
        document.getElementById('postForm').classList.toggle('show');
    }

    async function submitPost() {
        const category = document.getElementById('postCategory').value;
        const title    = document.getElementById('postTitle').value.trim();
        const content  = document.getElementById('postContent').value.trim();
        if (!title || !content) { showToast('âš ï¸ ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

        await db.collection('posts').add({
            authorUid:  currentUser.uid,
            authorName: currentUser.name,
            category, title, content,
            likes:    [],
            comments: [],
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        document.getElementById('postTitle').value   = '';
        document.getElementById('postContent').value = '';
        togglePostForm();
        showToast('âœ… ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    function renderFeed() {
        const q = (document.getElementById('feedSearch')?.value || '').toLowerCase();
        const list = allPosts.filter(p =>
            (p.title || '').toLowerCase().includes(q) ||
            (p.content || '').toLowerCase().includes(q) ||
            (p.authorName || '').toLowerCase().includes(q)
        );
        const el = document.getElementById('feedList');

        if (list.length === 0) {
            el.innerHTML = '<div class="empty-state"><div class="emoji">ğŸ“­</div><p>ì•„ì§ ê³µìœ ëœ í•™ìŠµ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ê¸€ì„ ì‘ì„±í•´ ë³´ì„¸ìš”!</p></div>';
            return;
        }

        el.innerHTML = list.map(p => {
            const liked    = (p.likes || []).includes(currentUser.uid);
            const dateStr  = p.createdAt ? p.createdAt.toDate().toLocaleDateString('ko-KR') : '';
            const comments = (p.comments || []).map(c =>
                `<div class="comment-item"><strong>${esc(c.authorName)}</strong>: ${esc(c.text)}</div>`
            ).join('');

            return `
            <div class="post-card">
                <div class="post-meta">
                    <span class="post-author">${esc(p.authorName)}</span>
                    <span class="post-date">${dateStr}</span>
                </div>
                <span class="post-category">${esc(p.category)}</span>
                <div class="post-title">${esc(p.title)}</div>
                <div class="post-body">${esc(p.content)}</div>
                <div class="post-actions">
                    <button class="${liked ? 'liked' : ''}" onclick="toggleLike('${p.id}')">
                        ${liked ? 'â¤ï¸' : 'ğŸ¤'} ì¢‹ì•„ìš” ${(p.likes||[]).length}
                    </button>
                    <button onclick="toggleComments('${p.id}')">
                        ğŸ’¬ ëŒ“ê¸€ ${(p.comments||[]).length}
                    </button>
                    ${p.authorUid === currentUser.uid ? `<button onclick="deletePost('${p.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>` : ''}
                </div>
                <div class="comments-section" id="comments-${p.id}">
                    ${comments}
                    <div class="comment-input-row">
                        <input type="text" id="ci-${p.id}" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                            onkeydown="if(event.key==='Enter')addComment('${p.id}')">
                        <button onclick="addComment('${p.id}')">ë“±ë¡</button>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    async function toggleLike(id) {
        const ref = db.collection('posts').doc(id);
        const doc = await ref.get();
        if (!doc.exists) return;
        const likes = doc.data().likes || [];
        if (likes.includes(currentUser.uid)) {
            await ref.update({ likes: firebase.firestore.FieldValue.arrayRemove(currentUser.uid) });
        } else {
            await ref.update({ likes: firebase.firestore.FieldValue.arrayUnion(currentUser.uid) });
        }
    }

    function toggleComments(id) {
        document.getElementById('comments-' + id).classList.toggle('show');
    }

    async function addComment(postId) {
        const input = document.getElementById('ci-' + postId);
        const text  = input.value.trim();
        if (!text) return;

        await db.collection('posts').doc(postId).update({
            comments: firebase.firestore.FieldValue.arrayUnion({
                authorUid:  currentUser.uid,
                authorName: currentUser.name,
                text,
                date: new Date().toISOString()
            })
        });
        input.value = '';
        showToast('ğŸ’¬ ëŒ“ê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        setTimeout(() => {
            const el = document.getElementById('comments-' + postId);
            if (el) el.classList.add('show');
        }, 300);
    }

    async function deletePost(id) {
        if (!confirm('ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        await db.collection('posts').doc(id).delete();
        showToast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ===== ë‚´ ë‹¨ì–´ì¥ =====
    function openVocabModal()  { document.getElementById('vocabModal').classList.add('show'); }
    function closeVocabModal() {
        document.getElementById('vocabModal').classList.remove('show');
        document.getElementById('vocabWord').value    = '';
        document.getElementById('vocabMeaning').value = '';
        document.getElementById('vocabExample').value = '';
    }

    async function addVocab() {
        const word    = document.getElementById('vocabWord').value.trim();
        const meaning = document.getElementById('vocabMeaning').value.trim();
        const example = document.getElementById('vocabExample').value.trim();
        if (!word || !meaning) { showToast('âš ï¸ ë‹¨ì–´ì™€ ëœ»ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.'); return; }

        await db.collection('vocabs').add({
            uid: currentUser.uid,
            word, meaning, example,
            status: 'learning',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        closeVocabModal();
        showToast('âœ… ë‹¨ì–´ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    async function toggleVocabStatus(id, cur) {
        await db.collection('vocabs').doc(id).update({
            status: cur === 'learning' ? 'done' : 'learning'
        });
    }

    async function deleteVocab(id) {
        if (!confirm('ì´ ë‹¨ì–´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        await db.collection('vocabs').doc(id).delete();
        showToast('ğŸ—‘ï¸ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    function renderVocab() {
        const q = (document.getElementById('vocabSearch')?.value || '').toLowerCase();
        const list = myVocabs.filter(v =>
            v.word.toLowerCase().includes(q) || v.meaning.includes(q)
        );
        const el = document.getElementById('vocabGrid');

        if (list.length === 0) {
            el.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="emoji">ğŸ“š</div><p>ì•„ì§ ë“±ë¡ëœ ë‹¨ì–´ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë‹¨ì–´ë¥¼ ì¶”ê°€í•´ ë³´ì„¸ìš”!</p></div>';
            return;
        }

        el.innerHTML = list.map(v => `
        <div class="vocab-card">
            <span class="vocab-status ${v.status==='done'?'status-done':'status-learning'}">
                ${v.status==='done' ? 'âœ… ì™„ë£Œ' : 'ğŸ“ í•™ìŠµì¤‘'}
            </span>
            <div class="word">${esc(v.word)}</div>
            <div class="meaning">${esc(v.meaning)}</div>
            ${v.example ? `<div class="example">"${esc(v.example)}"</div>` : ''}
            <div class="post-actions" style="margin-top:12px;">
                <button onclick="toggleVocabStatus('${v.id}','${v.status}')">
                    ${v.status==='done' ? 'ğŸ“ í•™ìŠµì¤‘ìœ¼ë¡œ' : 'âœ… ì™„ë£Œë¡œ'}
                </button>
                <button onclick="deleteVocab('${v.id}')">ğŸ—‘ï¸ ì‚­ì œ</button>
            </div>
        </div>`).join('');
    }

    // ===== ë©¤ë²„ ê´€ë¦¬ =====
    function renderMembers() {
        const q = (document.getElementById('memberSearch')?.value || '').toLowerCase();

        document.getElementById('memberStats').innerHTML = `
            <div class="stat-card"><div class="stat-number">${allMembers.length}</div><div class="stat-label">ì „ì²´ ë©¤ë²„</div></div>
            <div class="stat-card"><div class="stat-number">${allPosts.length}</div><div class="stat-label">ê³µìœ ëœ ê¸€</div></div>
            <div class="stat-card"><div class="stat-number">${myVocabs.length}</div><div class="stat-label">ë‚´ ë‹¨ì–´</div></div>
        `;

        const list = allMembers.filter(u =>
            (u.name||'').toLowerCase().includes(q) || (u.email||'').toLowerCase().includes(q)
        );

        document.getElementById('memberList').innerHTML = list.map(u => {
            const posts = allPosts.filter(p => p.authorUid === u.uid).length;
            const isMe  = u.uid === currentUser.uid;
            return `
            <li class="member-item">
                <div class="member-info">
                    <div class="member-avatar">${(u.name||'?').charAt(0)}</div>
                    <div>
                        <div class="member-name">${esc(u.name||'')} ${isMe ? '(ë‚˜)' : ''}</div>
                        <div class="member-role">${u.role==='admin'?'ğŸ‘‘ ê´€ë¦¬ì':'ğŸ‘¤ ë©¤ë²„'} Â· ê¸€ ${posts}ê°œ Â· ê°€ì… ${u.joinDate||''}</div>
                    </div>
                </div>
                <div class="member-actions">
                    ${currentUser.role==='admin' && !isMe ? `<button onclick="removeMember('${u.uid}')">ì‚­ì œ</button>` : ''}
                </div>
            </li>`;
        }).join('');
    }

    async function removeMember(uid) {
        if (!confirm('ì´ ë©¤ë²„ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\ní•´ë‹¹ ë©¤ë²„ì˜ ê¸€ê³¼ ë‹¨ì–´ë„ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤.')) return;

        // ê¸€ ì‚­ì œ
        const ps = await db.collection('posts').where('authorUid','==',uid).get();
        const b1 = db.batch();
        ps.forEach(d => b1.delete(d.ref));
        await b1.commit();

        // ë‹¨ì–´ ì‚­ì œ
        const vs = await db.collection('vocabs').where('uid','==',uid).get();
        const b2 = db.batch();
        vs.forEach(d => b2.delete(d.ref));
        await b2.commit();

        // ìœ ì € ì‚­ì œ
        await db.collection('users').doc(uid).delete();
        showToast('ğŸ—‘ï¸ ë©¤ë²„ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ===== ìœ í‹¸ =====
    function esc(str) {
        const d = document.createElement('div');
        d.textContent = str || '';
        return d.innerHTML;
    }
    </script>
</body>
</html>
